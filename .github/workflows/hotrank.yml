name: Daily HotNews Builder

on:
  schedule:
    - cron: '0 0 * * *'        # 每天 08:00 (北京)
  workflow_dispatch:

jobs:
  grab-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies           # ← 增加这一段
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run inline crawler
        run: |
          cat > grab.py << 'PY'
          import requests, re, json, datetime, sys
          today = datetime.date.today().strftime("%Y-%m-%d")

          URLS = {
              "微博":  f"https://raw.githubusercontent.com/SnailDev/weibo-hot-hub/main/archives/{today}.md",
              "知乎":  f"https://raw.githubusercontent.com/SnailDev/zhihu-hot-hub/main/archives/{today}.md",
              "微信":  f"https://raw.githubusercontent.com/SnailDev/wechat-hot-hub/main/archives/{today}.md",
              "头条":  f"https://raw.githubusercontent.com/SnailDev/toutiao-hot-hub/main/archives/{today}.md",
              "抖音":  f"https://raw.githubusercontent.com/SnailDev/douyin-hot-hub/main/archives/{today}.md"
          }

          pat = re.compile(r'\d+\.\s*\[(.+?)\]\((https?://[^)]+)\)')
          data = []
          for src, url in URLS.items():
              try:
                  txt = requests.get(url, timeout=20).text
                  for title, link in pat.findall(txt)[:10]:
                      data.append({"title": title.strip(),
                                   "link": link.strip(),
                                   "source": src})
              except Exception as e:
                  print(f"[WARN] {src} 获取失败: {e}", file=sys.stderr)

          out = f"hotnews_{today}.json"
          with open(out, "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          print(f"生成 {out}，共 {len(data)} 条")
          PY
          python grab.py

      - name: Commit & Push JSON
        run: |
          git config --global user.name  'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add hotnews_*.json
          git commit -m "Auto update hotnews $(date +'%Y-%m-%d')" || echo "No changes"
          git push
